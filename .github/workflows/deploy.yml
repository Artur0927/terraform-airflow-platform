name: Deploy to EC2
on:
  push:
    branches:
      - main
jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        
      - name: Deploy via SSH Proxy
        env:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          BASTION: ${{ secrets.BASTION_HOST }}
          TARGET: ${{ secrets.AIRFLOW_PRIVATE_IP }}
          USER: ${{ secrets.USERNAME }}
        run: |
          # 1. Setup SSH Key
          mkdir -p ~/.ssh
          printf "%s\n" "$PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Validate Key Format
          echo "Validating SSH Key format..."
          if ! ssh-keygen -y -f ~/.ssh/id_rsa > /dev/null; then
            echo "❌ CRITIAL ERROR: The SSH Private Key is invalid or corrupted."
            echo "Please verify that the 'EC2_SSH_KEY' GitHub Secret:"
            echo "  1. Starts with '-----BEGIN ... PRIVATE KEY-----'"
            echo "  2. Ends with '-----END ... PRIVATE KEY-----'"
            echo "  3. Has no extra whitespace at the start/end."
            exit 1
          else
            echo "✅ SSH Key is valid."
          fi
          
          # 2. Test Connection (Verbose)
          echo "Testing Connection to $TARGET via $BASTION..."
          ssh -v -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o ProxyCommand="ssh -v -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -W %h:%p $USER@$BASTION -i ~/.ssh/id_rsa" \
            -i ~/.ssh/id_rsa $USER@$TARGET "echo '✅ Connection Successful!'"
            
          # 3. Execute Deployment
          echo "Deploying..."
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o ProxyCommand="ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -W %h:%p $USER@$BASTION -i ~/.ssh/id_rsa" \
            -i ~/.ssh/id_rsa $USER@$TARGET << 'EOF'
            
            # Clone or Pull
            if [ ! -d "terraform-airflow-platform" ]; then
              echo "Cloning repository..."
              git clone https://github.com/Artur0927/terraform-airflow-platform.git
            fi
            
            cd terraform-airflow-platform
            echo "Pulling latest changes..."
            git pull origin main
            
            cd airflow
            echo "Restarting Airflow..."
            sudo /usr/local/bin/docker-compose down
            sudo /usr/local/bin/docker-compose up -d --build
          EOF
